# Android App

This directory contains the Android native project for MyContracts, generated by Capacitor.

## Features

The Android app now includes native mobile features:
- üì∑ **Camera Integration** - Take photos of contracts directly from the camera
- üñºÔ∏è **Gallery Picker** - Select files from device gallery
- üì§ **Native Share** - Share downloaded files with other apps
- üìÅ **File System Access** - Access and store files on device
- üì± **Mobile-Optimized UI** - Touch-friendly interface for mobile devices

## Building the APK

### Development Build (Debug APK with live reload)

For development with a running backend server on your computer:

```bash
cd frontend

# Option 1: Android Emulator
CAPACITOR_SERVER_URL=http://10.0.2.2:8080 npm run cap:build:android:dev

# Option 2: Physical Device (replace with your computer's IP)
CAPACITOR_SERVER_URL=http://192.168.1.100:8080 npm run cap:build:android:dev
```

The debug APK will be at: `app/build/outputs/apk/debug/app-debug.apk`

### Production Build (Release APK)

For production with bundled frontend files:

```bash
cd frontend

# Build with your production backend URL
VITE_API_URL=https://your-backend-url.com npm run cap:build:android:production

# Or use the simple command for default settings
npm run cap:build:android
```

The release APK will be at: `app/build/outputs/apk/release/app-release.apk`

### Quick Build Commands

```bash
cd frontend

# Development build for emulator
npm run cap:build:android:dev

# Production build
npm run cap:build:android:production

# Standard build (no backend URL configured)
npm run cap:build:android
```

## Environment Configuration

### Backend URL

The app can be configured to connect to different backend servers:

1. **Copy the environment template:**
   ```bash
   cp .env.example .env
   ```

2. **Edit `.env` and set your backend URL:**
   ```env
   # For production
   VITE_API_URL=https://api.mycontracts.com
   
   # For development/testing
   CAPACITOR_SERVER_URL=http://10.0.2.2:8080  # Emulator
   ```

3. **Build with the configuration:**
   ```bash
   npm run build:production
   ```

### Build Variants

- **Development Build (`cap:build:android:dev`)**: 
  - Uses debug signing
  - Connects to local backend via CAPACITOR_SERVER_URL
  - Supports live reload
  - Larger APK size

- **Production Build (`cap:build:android:production`)**:
  - Uses release signing (if configured)
  - Frontend files bundled into APK
  - Backend URL from VITE_API_URL
  - Optimized and minified

## APK Signing

The current configuration builds an **unsigned release APK** suitable for development and testing.

For production releases and Play Store submission, you need to configure APK signing:

1. **Generate a keystore:**
   ```bash
   keytool -genkey -v -keystore mycontracts-release-key.keystore -alias mycontracts -keyalg RSA -keysize 2048 -validity 10000
   ```

2. **Store the keystore securely** (do NOT commit to git)

3. **Add signing configuration to `app/build.gradle`:**
   ```gradle
   android {
       ...
       signingConfigs {
           release {
               storeFile file("../mycontracts-release-key.keystore")
               storePassword System.getenv("KEYSTORE_PASSWORD")
               keyAlias "mycontracts"
               keyPassword System.getenv("KEY_PASSWORD")
           }
       }
       buildTypes {
           release {
               signingConfig signingConfigs.release
               minifyEnabled false
               proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
           }
       }
   }
   ```

4. **Set environment variables before building:**
   ```bash
   export KEYSTORE_PASSWORD="your-keystore-password"
   export KEY_PASSWORD="your-key-password"
   ./gradlew assembleRelease
   ```

## Opening in Android Studio

You can open the project in Android Studio for more advanced development:

```bash
cd frontend
npm run cap:open:android
```

This will open the project in Android Studio where you can:
- Run the app on an emulator or connected device
- Debug native code
- Customize Android-specific features
- Generate signed APKs through the IDE

## Native Features

### Camera & Photo Capture

The app includes native camera integration for capturing contract documents:

- **Take Photo**: Opens the device camera to capture a new document
- **Choose from Gallery**: Selects existing photos from device
- **Auto-upload**: Captured photos are automatically uploaded to the backend

**Permissions Required:**
- `CAMERA` - For taking photos
- `READ_EXTERNAL_STORAGE` / `READ_MEDIA_IMAGES` - For accessing gallery

### File Sharing

Share downloaded contracts with other apps:

- Click the **üì§ Share** button next to any file download
- Choose where to share (Email, WhatsApp, Drive, etc.)

**Permissions Required:**
- `INTERNET` - For downloading files
- File provider configured in AndroidManifest.xml

### File System Access

Files are stored in the device's Documents folder:

- Downloaded contracts saved to `/Documents/`
- Accessible via Files app
- Persist even when app is closed

## Permissions

The app requests the following permissions (defined in `AndroidManifest.xml`):

- ‚úÖ **INTERNET** - Required for API communication
- ‚úÖ **CAMERA** - For document capture
- ‚úÖ **READ_EXTERNAL_STORAGE** - For accessing photos (Android ‚â§12)
- ‚úÖ **WRITE_EXTERNAL_STORAGE** - For saving files (Android ‚â§12)
- ‚úÖ **READ_MEDIA_IMAGES** - For accessing photos (Android ‚â•13)
- ‚úÖ **ACCESS_NETWORK_STATE** - For checking connectivity

All permissions are requested at runtime when needed.

## Troubleshooting

### Build Fails with "invalid source release" or Java Version Error

If you see an error like `error: invalid source release: 21`:

1. **Check your Java version:**
   ```bash
   java -version
   ```

2. **Ensure you're using Java 17 or compatible version:**
   - The project is configured to use Java 17
   - If you have Java 21+, the build.gradle is already configured to override it to Java 17
   - If you have Java < 17, you need to upgrade

3. **Verify the fix is in place:**
   The root `build.gradle` should contain:
   ```gradle
   subprojects {
       afterEvaluate { project ->
           if (project.hasProperty('android')) {
               project.android {
                   compileOptions {
                       sourceCompatibility JavaVersion.VERSION_17
                       targetCompatibility JavaVersion.VERSION_17
                   }
               }
           }
       }
   }
   ```

### Build Fails with "SDK not found"

Install Android SDK via Android Studio or set `ANDROID_HOME`:

```bash
export ANDROID_HOME=$HOME/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
```

### Camera Not Working

1. Check permissions in device settings
2. Ensure `android:hardwareAccelerated="true"` in manifest
3. Test on physical device (emulator camera may not work)

### Cannot Connect to Backend

For **emulator**:
- Use `10.0.2.2` instead of `localhost`
- Ensure backend is running on host machine
- Check firewall settings

For **physical device**:
- Use computer's local IP (e.g., `192.168.1.100`)
- Ensure device and computer are on same network
- Backend must be accessible from network (not just localhost)

### Files Not Uploading

1. Check backend URL in app settings
2. Verify backend is running and accessible
3. Check network connectivity
4. Look at Android Logcat for error messages

## CI/CD Integration

The GitHub Actions workflow automatically builds the APK on every merge to `main` or `development` branches. The APK is available as a release artifact.

To download CI-built APKs:
1. Go to the [Actions tab](https://github.com/felix-dieterle/mycontracts/actions)
2. Click on the latest workflow run
3. Scroll to "Artifacts" section
4. Download `mycontracts-{branch}-{commit}.apk`

**Note:** CI/CD builds produce unsigned APKs. To sign APKs in CI/CD, add the keystore and passwords as GitHub Secrets and configure the workflow accordingly.

## Testing on Device

### Via ADB (Android Debug Bridge)

```bash
# Install APK
adb install app/build/outputs/apk/release/app-release.apk

# View logs
adb logcat | grep MyContracts

# Uninstall
adb uninstall com.mycontracts.app
```

### Via File Transfer

1. Copy APK to device (USB, cloud, email, etc.)
2. Enable "Install from Unknown Sources" in device settings
3. Tap the APK file to install
4. Grant requested permissions

## Version Management

Update version in `app/build.gradle`:

```gradle
defaultConfig {
    versionCode 2        // Increment for each release
    versionName "1.1.0"  // Semantic version
}
```

**Version Code:** Must be incremented for each Play Store upload
**Version Name:** Human-readable version (e.g., "1.0.0", "2.1.3")

